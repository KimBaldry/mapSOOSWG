#' @title Create multiple SOOS Working Group Map from a file
#'
#' @author Kimberlee Baldry
#' @description This script contains a function to create all SOOS WG maps from a file. The function: - acesses the file - applies data from rows of the file to 1. plot a WG map using plot_WG_map() and 2. save the file as a .png file using save_map() - outputs a message for each sucessfull map and when teh run is complete
#'
#' @note In development
#'
#' @return It will let you know if the code worked!
#' @param filepath The fullname of the file. The file must contain the columns named "Acronym" (for the WG) and "Countries Represented"
#' @param outdir The directory where you would like .png files saved
#' @param lookupfile The fullname of the lookup table file. This file must contain 2 columns labeled "Country" (what SOOS records the country as) and "ISO3_name"
#' @import ggplot2
#' @import data.table
#' @import broom
#' @import rgeos
#' @import rworldmap
#' @import ggimage
#' @import tidyverse
#'
#' @export

# for development/debugging
# maindir = "C:/Users/kabaldry/OneDrive - University of Tasmania/Documents/SOOS"
# filename = file.path(maindir, "data", "SOOSWG_list_09022020.csv")
# outdir = file.path(maindir, "output","style1")
# lookupfile = file.path(maindir, "data", "country_lookup_table.txt")

WG_maps <- function(filename, outdir, lookupfile){

  # read the file
  data = read.csv(filename, header = T,  stringsAsFactors = F)
  colnames(data) = gsub("Ã¯..","",colnames(data)) # this is a bug that can occur from excel (yay excel)
  print(paste(basename(filename), "sucessfully opened"))
  # prepare data
  WG_names = data$Acronym
  countries = lapply(data$Countries.Represented, FUN = function(x){unlist(strsplit(x, split = "; "))})
  # check that all countries to be plotted appear in the country lookup table
  check = check_country_names(countries, lookupfile)
  if(any(check == "Failed")){break}
  countries = check
  # loop through WG
  for(rw in 1:length(WG_names)){
    # make plot object
    map = plot_WG_map(WG_names[rw], countries[[rw]])
    # save plot
    save_map(map,WG_names[rw], outdir)
  }
  print("Sucess! All maps were created")
}
