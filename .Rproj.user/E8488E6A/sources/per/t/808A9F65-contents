#' @title Create multiple SOOS Geocoded Maps from a file
#'
#' @author Kimberlee Baldry
#' @description This script contains a function to create all SOOS WG maps from a file. The function: - acesses the file - applies data from rows of the file to 1. plot a WG map using plot_WG_map() and 2. save the file as a .png file using save_map() - outputs a message for each sucessfull map and when teh run is complete
#'
#' @note In development. Editing.
#'
#' @return It will let you know if the code worked!
#' @param filepath The fullname of the file. The file must contain the columns named "Acronym" (for the WG) and "Countries Represented" and "Institutions"
#' @param outdir The directory where you would like .png files saved
#' @param lookupfile The fullname of the lookup table file. This file must contain 2 columns labeled "Country" (what SOOS records the country as) and "ISO3_name"
#' @param geocodefile The fullname of the geocode file. This file must contain 3 columns labeled "Institution" (what SOOS records the insitution as), "lat" and "lon"
#' @param hilight_countries If true, also colour the member countries.
#' @import ggplot2
#' @import data.table
#' @import broom
#' @import rgeos
#' @import rworldmap
#' @import ggimage
#' @import tidyverse
#' @import raster
#' @import sf
#'
#' @export

# for development/debugging
# maindir = "C:/Users/kabaldry/OneDrive - University of Tasmania/Documents/SOOS"
# filename = file.path(maindir, "data", "SOOSWG_list_09022020.csv")
# outdir = file.path(maindir, "output","style1")
# lookupfile = file.path(maindir, "data", "country_lookup_table.txt")

geocode_maps <- function(filename, outdir, lookupfile = NULL, geocodefile, hilight_countries = T){

  ### read the files
  data = read.csv(filename, header = T,  stringsAsFactors = F)
  colnames(data) = gsub("ï..","",colnames(data)) # this is a bug that can occur from excel (yay excel)
  print(paste(basename(filename), "sucessfully opened"))

  geo_data = read.csv(geocodefile, header = T,  stringsAsFactors = F)
  colnames(geo_data) = gsub("ï..","",colnames(geo_data)) # this is a bug that can occur from excel (yay excel)
  print(paste(basename(geocodefile), "sucessfully opened"))


  ### prepare data
  WG_names = data$Acronym
  # country data
  if(hilight_countries){
  countries = lapply(data$Countries.Represented, FUN = function(x){unlist(strsplit(x, split = "; "))})
  # check that all countries to be plotted appear in the country lookup table
  check = check_country_names(countries, lookupfile)
  if(any(check == "Failed")){break}
  countries = check}

  # institution data


  ### loop through WG and plot
  for(rw in 1:length(WG_names)){
    # make plot object
    map = plot_geocode_map(WG_names[rw], countries[[rw]], institutions , hilight_countries = hilight_countries)
    # save plot
    save_map(map,WG_names[rw], outdir)
  }
  print("Sucess! All maps were created")
}
